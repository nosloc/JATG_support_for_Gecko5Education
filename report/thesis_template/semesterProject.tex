%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% EPFL report package, main thesis file
% Goal: provide formatting for theses and project reports
% Author: Mathias Payer <mathias.payer@epfl.ch>
%
% To avoid any implication, this template is released into the
% public domain / CC0, whatever is most convenient for the author
% using this template.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\documentclass[a4paper,11pt,oneside]{report}
% Options: MScThesis, BScThesis, MScProject, BScProject
\usepackage[MScProject,lablogo]{EPFLreport}
\usepackage{xspace}

\title{JTAG support \\for Gecko5Education board}
\author{Antoine Colson}
\supervisor{Prof. Ties Jan Henderikus Kluter}

\newcommand{\boardName}{Gecko5Education \xspace}

\begin{document}
\maketitle
% \makededication
% \makeacks

% \begin{abstract}
% The \sysname tool enables lateral decomposition of a multi-dimensional
% flux compensator along the timing and space axes.

% The abstract serves as an executive summary of your project.
% Your abstract should cover at least the following topics, 1-2 sentences for
% each: what area you are in, the problem you focus on, why existing work is
% insufficient, what the high-level intuition of your work is, maybe a neat
% design or implementation decision, and key results of your evaluation.
% \end{abstract}

% \begin{frenchabstract}
% For a doctoral thesis, you have to provide a French translation of the
% English abstract. For other projects this is optional.
% \end{frenchabstract}

\maketoc

%%%%%%%%%%%%%%%%%%%%%%
\chapter{Introduction}
%%%%%%%%%%%%%%%%%%%%%%

    This project focuses on implementing and testing robust JTAG (Joint Test Action Group) communication 
and control on the \boardName board. The goal is to develop 
low-level infrastructure that enables JTAG-based access to internal system components, 
such as memory and peripherals, paving the way for advanced debugging, testing, and programming capabilities.
Several challenges arose from this project statement.
First, the board was designed exclusively for educational use at EPFL, and as a result, it lacks official documentation which leaves its internals largely unexplored in this context. 
Second, no prior work had been done on enabling JTAG access for the \boardName board; existing references focuse on different boards or architectures. 
Finally, the built-in JTAG interface is extremely minimalistic, exposing only the bare features required by the standard, with only little support for custom extensions or advanced control.\\

To address these challenges, the project was divided into two main milestones: 

\begin{itemize}
    \item Establish basics communication via the JTAG interface and demonstrate control by using 
    on-board RGB LEDs.
    \item Extend the JTA interface to suppoort memory accesses and peripherals control, by providing read and write
    operations to any component on the bus architecture.
\end{itemize}

In summary, this project aimed to transform the previously underutilized JTAG interface of the \boardName board into a powerful low-level communication path
that can later be used by EPFL students. 
Both milestones were successfully completed: reliable communication with the board was achieved, 
and the interface was extended to provide full memory and peripheral access. As a result, 
software can now interact with the board through a high-level abstraction of the JTAG interface, hiding much of the underlying complexity.
The remainder of this report details the background of the project, the design decisions made, the concrete implementation and the evaluation of the updated JTAG interface.


%%%%%%%%%%%%%%%%%%%%
\chapter{Background}
%%%%%%%%%%%%%%%%%%%%

This chapter provides the necessary context for the project.  
It introduces the \boardName board, essential FPGA concepts,  
the board’s initial architecture related to this project, and the JTAG protocol.  
It also covers the open-source toolchain used for development,  
simulation, and debugging.  

\section{The \boardName Board}
\label{sec:board}

The \boardName board is an FPGA development platform primarily  
used for teaching digital systems and computer architecture at EPFL.  
It is designed to give students hands-on experience and features  
a Lattice ECP5 FPGA at its core.  
The board also includes various peripherals suitable for system-on-chip experimentation,  
such as DRAM memory blocks, general-purpose I/Os (GPIOs) like push buttons and switches,  
an RGB LED matrix, and a UART interface for serial communication.  

Although the board provides a JTAG port through a USB-C connector,  
it was previously unused due to its minimal implementation and  
the availability of UART for communication.  

\section{FPGA Basics}

As mentioned in Section~\ref{sec:board}, the \boardName board is built around a Lattice ECP5 FPGA.  
Unlike CPUs that execute software, FPGAs are reconfigurable hardware platforms  
used to implement digital logic circuits.  
They are programmed using hardware description languages (HDLs);  
in this project, Verilog is used to describe the hardware's structure and behavior.  
The HDL code is then synthesized, placed, and routed to produce a bitstream,  
which is loaded into the FPGA.  

In this project, the FPGA is used to enhance an existing microcontroller-based architecture  
by adding components for JTAG support.  

\section{Toolchain}

The project uses the open-source \texttt{oss-cad-suite},  
a comprehensive set of tools for FPGA development.  
Icarus Verilog is used for simulation,  
and GTKWave is employed for waveform visualization.  
Yosys and nextpnr-ecp5 handle synthesis and placement,  
while ecppack generates the bitstream.  
The design is then loaded onto the FPGA using openFPGALoader.  

Additionally, \texttt{OpenOCD} (Open On-Chip Debugger) is used  
to interact with the JTAG interface.  
It provides a telnet-accessible environment to send low-level JTAG commands,  
making it possible to control TAP states and directly drive input signals.  

\section{Initial System Architecture}

The default system architecture on the board is based on an OpenRISC microprocessor,  
implementing the OpenRISC 1000 ISA in a 5-stage pipelined configuration.  
It is connected to other modules via a 32-bit shared bus.  
The default setup includes a UART module, an SDRAM memory controller,  
a camera interface, and various GPIO components.  

All modules are interconnected through the shared bus,  
which is designed to be easily extensible—  
an essential feature leveraged in the second milestone of this project.  

However, for the first milestone,  
the JTAG interface is used only to control the RGB LEDs,  
which are directly mapped to GPIOs.  

\section{JTAG Protocol}

The JTAG protocol is the core focus of this project.  
Defined by the IEEE 1149.1 standard,  
JTAG (Joint Test Action Group) was introduced in the 1990s  
to facilitate testing and debugging of printed circuit boards.  
It uses boundary-scan techniques to check inter-chip connections  
without requiring physical access to individual pins.  

Today, JTAG is widely used for in-system programming, secure provisioning,  
and system-level debugging in embedded systems.  

The interface includes four required signals and one optional:  

\begin{itemize}
    \item \textbf{TDI (Test Data In)} — Serial input line.  
    \item \textbf{TDO (Test Data Out)} — Serial output line.  
    \item \textbf{TCK (Test Clock)} — Synchronizes data shifting.  
    \item \textbf{TMS (Test Mode Select)} — Drives the JTAG finite state machine.  
    \item \textbf{TRST (Test Reset)} — Optional asynchronous reset line.  
\end{itemize}

JTAG communication is governed by the TAP (Test Access Port) controller,  
which operates as a finite state machine.  
Key states include:  

\begin{itemize}
    \item \textbf{Test-Logic Reset} — Resets the TAP controller.  
    \item \textbf{Run-Test/Idle} — Wait state for idle periods.  
    \item \textbf{Capture-IR / Shift-IR / Update-IR} — Instruction register operations.  
    \item \textbf{Capture-DR / Shift-DR / Update-DR} — Data register operations.  
\end{itemize}

The TAP state transitions are determined by the TMS input on rising edges of TCK.  
By controlling TMS, TDI, and TCK, users can navigate the state machine,  
shift in instructions, and exchange data.  

Because JTAG relies on shift registers, it supports bidirectional communication:  
data can be shifted in via TDI and read out via TDO simultaneously.  
In this project, this mechanism is used to control LEDs  
and access memory and peripheral modules on the \boardName board.  


%%%%%%%%%%%%%%%%
\chapter{Design}
%%%%%%%%%%%%%%%%

Introduce and discuss the design decisions that you made during this project.
Highlight why individual decisions are important and/or necessary. Discuss
how the design fits together.

This section is usually 5-10 pages.


%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Implementation}
%%%%%%%%%%%%%%%%%%%%%%%%

The implementation covers some of the implementation details of your project.
This is not intended to be a low level description of every line of code that
you wrote but covers the implementation aspects of the projects.

This section is usually 3-5 pages.


%%%%%%%%%%%%%%%%%%%%
\chapter{Evaluation}
%%%%%%%%%%%%%%%%%%%%

In the evaluation you convince the reader that your design works as intended.
Describe the evaluation setup, the designed experiments, and how the
experiments showcase the individual points you want to prove.

This section is usually 5-10 pages.


%%%%%%%%%%%%%%%%%%%%%%
\chapter{Related Work}
%%%%%%%%%%%%%%%%%%%%%%

The related work section covers closely related work. Here you can highlight
the related work, how it solved the problem, and why it solved a different
problem. Do not play down the importance of related work, all of these
systems have been published and evaluated! Say what is different and how
you overcome some of the weaknesses of related work by discussing the 
trade-offs. Stay positive!

This section is usually 3-5 pages.


%%%%%%%%%%%%%%%%%%%%
\chapter{Conclusion}
%%%%%%%%%%%%%%%%%%%%

In the conclusion you repeat the main result and finalize the discussion of
your project. Mention the core results and why as well as how your system
advances the status quo.

\cleardoublepage
\phantomsection
\addcontentsline{toc}{chapter}{Bibliography}
\printbibliography

% Appendices are optional
% \appendix
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \chapter{How to make a transmogrifier}
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% In case you ever need an (optional) appendix.
%
% You need the following items:
% \begin{itemize}
% \item A box
% \item Crayons
% \item A self-aware 5-year old
% \end{itemize}

\end{document}